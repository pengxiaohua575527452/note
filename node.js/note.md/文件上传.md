## 单个文件上传
- 前端传递过来的数据格式 - 通过 formData 传递过来的
```
------WebKitFormBoundaryuupgvznXd8nh6U4W // 表示表单的边界
Content-Disposition: form-data; name="file"; filename="d1b1b1754caa40f886b6cbeb4b84a310.jpeg"
Content-Type: image/jpeg
<!-- 这里中间是具体的文件数据 -->
------WebKitFormBoundaryuupgvznXd8nh6U4W-- // 表示表单的边界


```


```
let data = []
// 用数组保存传递进来的数据
req.on('data', buf=>{
  data.push(buf)
})

// 使用buffer 保存
// <Buffer 2d 2d 2d 2d 2d 2d 57 65 62 4b 69 74 46 6f 72 6d 42 6f 75 6e 64 61 72 79 75 75 70 67 76 7a 6e 58 64 38 6e 68 36 55 34 57 0d 0a 43 6f 6e 74 65 6e 74 2d ... 35057 more bytes>
let buffer = Buffer.concat(data)

// 找出数据中的 回到行首[\r === 13] 和 换行符[\n === 10]
let len = buffer.length;

// 保存 [\r\n] 字符的位置
// 实际可能的数据结构是 [ 40, 135, 161, 163, 35061, 35105 ]
// 其中 ------WebKitFormBoundaryuupgvznXd8nh6U4W 对应的是 buffer.slice(0, rems[0]) 之间的值
// 其中 Content-Disposition: form-data; name="file"; filename="d1b1b1754caa40f886b6cbeb4b84a310.jpeg" 对应的 buffer.slice(rems[0]+2, rems[1]) 之间的值, +2 的原因是需要排除 \n
// 其中 Content-Type: image/jpeg 对应的是 buffer.slice(rems[1]+2, rems[2])
// 其中 数据的主题内容是 buffer.slice(rems[3]+2, rems[rems.length - 2]) 
// 其中 ------WebKitFormBoundaryuupgvznXd8nh6U4W-- 是 buffer.slice(rems[rems.length - 2])
let rems = []
for(let i=0; i< len-1; i++){
  let v = buffer[i]
  let v2 = buffer[i+1]
  if(v === 13 && v2 === 10){
    rem.push(i)
  }
}

// 获取文件的名称
let strDescription = buffer.slice(rems[0]+2, rems[1]).toString()
let fileName = strEscription.match(/filename=\".*\"/g)[0].split('"')[1]

// 获取文件的主体内容
let fileBody = buffer.slice(rems[3]+2, rems[rems.length - 2 ])

// 把主体内容写入文件
// 一般是用ID保存文件，文件名和ID映射表保存到 数据库中
FS
.writeFile(`path/${filename}`, fileBody, callback)

```

## 多文件上传-用来解析buffer 的核心代码
```
buffer.forEach((buf,index)=>{
  if(parseInt(buf) === 13 && parseInt(buffer[index + 1]) === 10){
    let str = buffer.slice(preIndex, index).toString()
    if(str.indexOf('Content-Disposition') != -1){
      bufferArr.push({
        description: str,
      })
    }else if(
      str.indexOf('Content-Type') != -1
      // 防止HTML文件中的 ccontent-type
      &&  !bufferArr[bufferArr.length - 1].contentType   
    ){
      bufferArr[bufferArr.length - 1].contentType = str
    }else if(
      str.indexOf('------WebKitFormBoundary') == -1 
      && str.length !== 0  
      && bufferArr.length != 0
    ){
      bufferArr[bufferArr.length - 1].fileBody = buffer.slice(preIndex, index)
    }
      
    if(
      !(str.length === 4 && str.indexOf('PNG')!== -1)
    ){
      preIndex = index + 2
    }
  }
})

```